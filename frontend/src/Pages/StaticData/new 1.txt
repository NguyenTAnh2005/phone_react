import { useEffect, useState } from "react";
// DL gia JSON LOAD LEN
import { listCartItems as mockData } from "../Data_Test/CARTS"; // ƒê·ªïi t√™n ƒë·ªÉ r√µ r√†ng
import { scrollToTopSmooth } from "../utils/utils";
import { CartProduct } from "../Components/product_card";

// --------------------------------------------------------


export function Cart() {
    const [listCartItem, setListCartItem] = useState([]);
    // üí° Thay ƒë·ªïi 1: Ch·ªâ l∆∞u ID c·ªßa c√°c sp ƒë∆∞·ª£c ch·ªçn. S·∫°ch s·∫Ω v√† d·ªÖ qu·∫£n l√Ω h∆°n.
    const [selectedVariantIds, setSelectedVariantIds] = useState([]);

    const fetched_cart_items = () => {
        // FETCH API GET TAI DAY
        // GIA LAP
        const copy_listCartItem = mockData.listCartItems; // L·∫•y t·ª´ mock data ƒë√£ import
        setListCartItem(copy_listCartItem);
    }

    // Load Du lieu khi moi tai trang
    useEffect(() => { fetched_cart_items(); }, []);

    // üí° Thay ƒë·ªïi 2: S·ª≠a logic handleSelect, gi·ªù ch·ªâ l√†m vi·ªác v·ªõi 'variant_id'
    const handleSelect = (variant_id) => {
        setSelectedVariantIds((prev) => {
            // N·∫øu ƒë√£ c√≥ ID trong m·∫£ng -> B·ªè ra (deselect)
            if (prev.includes(variant_id)) {
                return prev.filter((id) => id !== variant_id);
            }
            // N·∫øu ch∆∞a c√≥ -> Th√™m v√†o (select)
            else {
                return [...prev, variant_id];
            }
        });
    }

    // üí° Thay ƒë·ªïi 3: H√†m x·ª≠ l√Ω tƒÉng/gi·∫£m s·ªë l∆∞·ª£ng (ƒê√ÇY L√Ä PH·∫¶N TR·∫¢ L·ªúI C√ÇU H·ªéI C·ª¶A B·∫†N)
    const handleQuantityChange = (variant_id, new_count) => {
        // Ch·ªâ cho ph√©p s·ªë l∆∞·ª£ng >= 1
        if (new_count < 1) return;

        // 1. C·∫≠p nh·∫≠t state local ngay l·∫≠p t·ª©c (ƒë·ªÉ UI m∆∞·ª£t)
        setListCartItem((prevList) =>
            prevList.map((item) =>
                item.variant_id === variant_id
                    ? { ...item, cart_count: new_count } // T√¨m ƒë√∫ng item v√† c·∫≠p nh·∫≠t count
                    : item
            )
        );

        // 2. (Gi·∫£ l·∫≠p) G·ª≠i API l√™n server
        // Trong th·ª±c t·∫ø, b·∫°n s·∫Ω d√πng 'debounce' ·ªü ƒë√¢y
        console.log(`(Gi·∫£ l·∫≠p API) C·∫≠p nh·∫≠t variant_id ${variant_id} l√™n s·ªë l∆∞·ª£ng ${new_count}`);
    }

    // H√†m helper cho n√∫t +
    const handleIncrease = (variant_id) => {
        const item = listCartItem.find(p => p.variant_id === variant_id);
        if (item) {
            handleQuantityChange(variant_id, item.cart_count + 1);
        }
    }

    // H√†m helper cho n√∫t -
    const handleDecrease = (variant_id) => {
        const item = listCartItem.find(p => p.variant_id === variant_id);
        if (item && item.cart_count > 1) { // Ch·ªâ gi·∫£m khi > 1
            handleQuantityChange(variant_id, item.cart_count - 1);
        }
    }


    // üí° Thay ƒë·ªïi 4: handleDelete gi·ªù s·∫Ω log ID v√† c·∫≠p nh·∫≠t l·∫°i UI
    const handleDelete = () => {
        if (selectedVariantIds.length === 0) {
            alert("B·∫°n ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o ƒë·ªÉ x√≥a!");
            return;
        }

        alert("ƒê√£ x√≥a c√°c s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn. Xem th√¥ng tin b√™n console!");
        console.log("Cac variant_id duoc xoa: ", selectedVariantIds);

        // (Gi·∫£ l·∫≠p API) G·ª≠i 'selectedVariantIds' l√™n server ƒë·ªÉ x√≥a
        // ...

        // Sau khi API th√†nh c√¥ng, c·∫≠p nh·∫≠t UI:
        setListCartItem((prev) =>
            prev.filter((item) => !selectedVariantIds.includes(item.variant_id))
        );
        // X√≥a c√°c l·ª±a ch·ªçn
        setSelectedVariantIds([]);
    }

    // üí° Thay ƒë·ªïi 5: handleCheckout log ƒë√∫ng c√°c ID
    const handleCheckout = () => {
        if (selectedVariantIds.length === 0) {
            alert("B·∫°n ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o ƒë·ªÉ mua!");
            return;
        }

        alert("B·∫°n mu·ªën mua ngay s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn, xem th√¥ng tin b√™n console!");
        
        console.log("Cac variant_id duoc ch·ªçn mua ngay: ", selectedVariantIds);
    }

    const base_link = "https://res.cloudinary.com/df5mtvzkn/image/upload/q_auto,f_auto/WEB_SELL_PHONE__PROJECT/TEST/Test_IMG/"

    // üí° Thay ƒë·ªïi 6: S·ª≠a l·ªói `listProduct` -> `listCartItem`
    const copy_arr = listCartItem.map(p => {
        return (
            <CartProduct
                baselink={base_link}
                // üí° Thay ƒë·ªïi 7: S·ª≠a l·ªói prop 'product' -> 'cart_item'
                cart_item={p}
                key={`${p.product_id}-${p.variant_id}`}
                // üí° Thay ƒë·ªïi 8: Logic 'checked' v√† 'onChange' d·ª±a tr√™n 'selectedVariantIds'
                checked={selectedVariantIds.includes(p.variant_id)}
                onChange={() => { handleSelect(p.variant_id) }}
                // üí° Thay ƒë·ªïi 9: Truy·ªÅn h√†m x·ª≠ l√Ω s·ªë l∆∞·ª£ng xu·ªëng
                onIncrease={() => handleIncrease(p.variant_id)}
                onDecrease={() => handleDecrease(p.variant_id)}
            />)
    })
    return (
        <>
            {scrollToTopSmooth()}
            <div className="bg-slate-50 animate__animated animate_fadeIn py-5">
                <div className="text-center">
                    <div className="flex font-bold text-5xl text-mainCL gap-5 justify-center">
                        <i className="bi bi-cart-check"></i>
                        <p className="">
                            Gi·ªè h√†ng
                        </p>
                    </div>
                    <p className="text-slate-800 font-semibold text-xl mt-3">
                        Ki·ªÉm tra c√°c m·∫∑t h√†ng ƒë√£ ch·ªçn v√† s·∫µn s√†ng ƒë·∫∑t mua.
                    </p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 p-5 gap-5 bg-white w-[90%] mx-auto mt-5 rounded-lg shadow-lg overflow-hidden max-h-[400px] md:max-h-[300px] overflow-y-scroll">
                    {/* üí° Thay ƒë·ªïi 10: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p gi·ªè h√†ng tr·ªëng */}
                    {listCartItem.length > 0 ? copy_arr : (
                        <p className="text-center text-gray-500 md:col-span-2">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
                    )}
                </div>
                <div className="w-[90%] mx-auto mt-5 flex justify-end gap-5 md:justify-center">
                    <button
                        onClick={handleDelete}
                        className="text-mainCL border border-mainCL px-2 py-1 rounded-md font-semibold">
                        X√≥a
                    </button>
                    <button
                        onClick={handleCheckout}
                        className="text-white bg-mainCL px-2 py-1 rounded-md font-semibold">
                        Mua ngay
                    </button>
                </div>
            </div>
        </>
    );
}

