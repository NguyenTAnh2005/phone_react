import { useState, version } from "react";
import { eg_account, list_cart_product, eg_hotline } from "../Data_Test/Data_Home_Test";
import { priceFormatter } from "../utils/utils";


export function Order({ account = eg_account, hotlineList = eg_hotline, list_product = list_cart_product }) {

    const [addressList, setAddressList] = useState(eg_hotline);

    // l·∫•y address m·∫∑c ƒë·ªãnh
    const [selectedAddress, setselectedAddress] = useState(() => {
        const found = addressList.find(a => a.hotline_default === true);
        // N·∫øu found t·ªìn t·∫°i (truthy) ‚Üí tr·∫£ v·ªÅ found.
        // N·∫øu kh√¥ng c√≥ found ‚Üí th·ª≠ l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n c·ªßa addressList (addressList?.[0]).
        // D·∫•u ?. ƒë·ªÉ tr√°nh l·ªói n·∫øu addressList b·ªã null ho·∫∑c undefined.
        // N·∫øu c·∫£ hai ƒë·ªÅu kh√¥ng c√≥ ‚Üí tr·∫£ v·ªÅ null.
        return found || addressList?.[0] || null;
    });

    // danh sach cac chi tiet --- KHOI TAO BAN DAU MAC DINH count =1
    const initDetail = list_cart_product.map(p => ({
        variant_id: p.variant_id,
        count: 1,
        price: p.variant_ph_final_price,
        unit_price: p.variant_ph_final_price,
    }));

    // Form gui data tao Order
    const [formOrderData, setFormOrderData] = useState({
        id: "",
        hotline_id: selectedAddress.hotline_id,
        account_id: account.account_id,
        buy_time: "",
        rec_time: "",
        type_pay: "",
        state: "PREPARE",
        detail: initDetail,
        total_price: initDetail.reduce((acc, d) => acc + d.unit_price, 0),
    });

    // Xu ly thay doi so luong => thay doi count + gia tien 
    function handleChangeQuantity(variant_id, newcount) {
        setFormOrderData((prev) => {
            const newDetail = prev.detail.map(d => {
                const new_unit_price = d.price * newcount;
                if (d.variant_id === variant_id) {
                    return { ...d, count: newcount, unit_price: new_unit_price };
                }
                return d;
            });
            const new_total_price = newDetail.reduce((acc, d) => acc + d.unit_price, 0);
            return { ...prev, detail: newDetail, total_price: new_total_price }
        })
    }

    // Xu ly dat hang
    const handleSubmitOrder = (e) => {
        e.preventDefault();
        const timeNow = Date.now();
        const orderID = `${timeNow}--${account.account_id}--${selectedAddress.hotline_id}`
        // T·∫°o b·∫£n sao d·ªØ li·ªáu m·ªõi
        const newOrderData = {
            ...formOrderData,
            id: orderID,
            buy_time: new Date().toISOString(),
            rec_time: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
        };

        setFormOrderData(newOrderData);
        console.log("üßæ ORDER SUBMITTED:", newOrderData);
    }

    return (
        <>
            <form onSubmit={handleSubmitOrder} className="p-4 border rounded space-y-3">
                <h2 className="font-bold text-lg">Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <div className=" border border-gray-300 p-3">
                    <table className="border-collapse text-sm">
                        <thead className="uppercase font-medium text-mainCL">
                            <tr className="">
                                <th className=" px-4 ">
                                    T√™n h√†ng h√≥a
                                </th>
                                <th className=" px-4 ">
                                    ƒê∆°n gi√°
                                </th>
                                <th className=" px-4 ">
                                    S·ªë l∆∞·ª£ng
                                </th>
                                <th className=" px-4 ">
                                    Th√†nh ti·ªÅn
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {list_product.map((p, i) => (
                                <OrderDetail
                                    key={p.product_id}
                                    product={p}
                                    value={formOrderData.detail[i].count}
                                    // value l√† l·∫•y gi√° tr·ªã count c·ªßa sp ƒë√≥ trongg initDetail cua formOrderData 
                                    onChange={handleChangeQuantity}
                                />
                            ))}
                        </tbody>
                    </table>
                    <div className="text-start font-semibold mt-2">
                        <span>
                            T·ªïng ti·ªÅn:
                        </span>
                        <span className="text-mainCL ms-2">
                            {priceFormatter(formOrderData.total_price)} ƒë
                        </span>
                    </div>
                </div>
                <button
                    type="submit"
                    className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                    ƒê·∫∑t h√†ng
                </button>
            </form>
        </>
    )

}

function OrderAddress() {

}
function OrderPrice() {

}
function OrderTypePay() {

}
function OrdeTime() {

}

function OrderDetail({ product, value, onChange }) {
    const price = product.variant_ph_final_price ? product.variant_ph_final_price : product.variant_ph_final_price;
    const handlePlus = () => {
        onChange(product.variant_id, value + 1);
    }
    const handleMinus = () => {
        if (value >= 1) {
            onChange(product.variant_id, value - 1);
        }
    }
    return (
        <tr className="">
            <td className="font-semibold px-4 py-2">
                {product.phone_name} {product.variant_ph_ram}GB/{product.variant_ph_rom} ({product.variant_ph_color})
            </td>
            <td className="px-4 py-2">
                {priceFormatter(price)}
            </td>
            {/* S·ªë l∆∞·ª£ng */}
            <td className="px-4 py-2">
                <div className="flex font-semibold text-mainCL justify-between">
                    <i
                        onClick={handleMinus}
                        className="bi bi-dash-square"
                    >
                    </i>
                    <span className="font-semibold text-center">{value}</span>
                    <i
                        onClick={handlePlus}
                        className="bi bi-plus-square"
                    >
                    </i>
                </div>
            </td>
            {/* Tong tien  */}
            <td className=" text-end font-semibold">
                {priceFormatter(price * value)} ƒë
            </td>
        </tr>
    )
}




